"use strict";(()=>{var e={};e.id=810,e.ids=[810],e.modules={1185:e=>{e.exports=require("mongoose")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},2048:e=>{e.exports=require("fs")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},4956:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>v,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>h,staticGenerationAsyncStorage:()=>y});var n={};r.r(n),r.d(n,{GET:()=>m});var o=r(9303),i=r(8716),a=r(670),s=r(2021),u=r(5310),p=r(2880),d=r(5743);function c(e){return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(e)}function l(e){return e.toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"})}async function m(e){await (0,s.u)();let{searchParams:t}=new URL(e.url),r=function(e){let t=e.get("startDate"),r=e.get("endDate"),n=e.get("month"),o={};if(t&&r){let e=new Date(t),n=new Date(r);o.startTime={$gte:e,$lte:n}}else if(n){let[e,t]=n.split("-").map(Number),r=new Date(e,t-1,1),i=new Date(e,t,0,23,59,59);o.startTime={$gte:r,$lte:i}}return o}(t),[n,o]=await Promise.all([u.z.find(r).sort({startTime:-1}).lean(),p.TV.find().lean()]),i=(0,d.Y)(),a=Object.fromEntries(o.map(e=>[e._id.toString(),e])),m=n.map(e=>{let t=a[e.tv?.toString()]||{};return{"TV Name":`${t.name||"-"} (${t.psType||"-"})`,"IP Address":t.ipAddress||"-","Start Time":new Date(e.startTime).toLocaleString("id-ID"),"Duration (hours)":(e.duration/60).toFixed(2),Status:"Ended"===e.status?"Ended":"Active",Fee:e.fee||0}}),f=Object.keys(m[0]||{}),g=[],y="Semua Periode",h=t.get("startDate"),S=t.get("endDate"),v=t.get("month");if(h&&S){let e=new Date(h),t=new Date(S);y=`${l(e)} - ${l(t)}`}else if(v){let[e,t]=v.split("-").map(Number);y=new Date(e,t-1).toLocaleDateString("id-ID",{month:"long",year:"numeric"})}g.push(`Periode: ${y}`),g.push(""),g.push(f.join(",")),g.push(...m.map(e=>f.map(t=>`"${(e[t]??"").toString().replace(/"/g,'""')}"`).join(",")));let D=n.reduce((e,t)=>e+(t.fee||0),0);if(g.push(""),g.push(`Total Fee,,${c(D)}`),i?.mode==="sharing"&&i?.sharePercent){let e=Math.floor(i.sharePercent/100*D);g.push(`Sharing Fee (${i.sharePercent}%),,${c(e)}`)}return new Response(g.join("\n"),{headers:{"Content-Type":"text/csv","Content-Disposition":`attachment; filename="Report ${y}.csv"`}})}let f=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/reports/export/route",pathname:"/api/reports/export",filename:"route",bundlePath:"app/api/reports/export/route"},resolvedPagePath:"/Users/figar_jr/project/android-tv-timer/app/api/reports/export/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:h}=f,S="/api/reports/export/route";function v(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:y})}},5743:(e,t,r)=>{r.d(t,{Y:()=>g,R:()=>f});var n=r(2048),o=r.n(n),i=r(5315),a=r.n(i),s=r(4770),u=r.n(s);let p=a().join(process.cwd(),"license.json"),d=a().join(process.cwd(),"public.pem");function c(){try{let e=o().readFileSync(p,"utf8"),{data:t,signature:r}=JSON.parse(e),n=o().readFileSync(d,"utf8"),i=u().createVerify("RSA-SHA256"),a=JSON.stringify(t);if(i.update(a),i.end(),!i.verify(n,r,"base64"))return console.error("❌ License verification failed."),null;return t}catch(e){return console.error("❌ Error reading license:",e),null}}var l=r(9801),m=r.n(l);function f(){let e=c();if(!e||new Date>new Date(e.expiredAt))return!1;let t=function(){for(let e of Object.values(m().networkInterfaces()))for(let t of e||[])if(!t.internal&&t.mac&&"00:00:00:00:00:00"!==t.mac)return t.mac.toLowerCase();return"unknown"}();return Array.isArray(e.mac)&&e.mac.includes(t)}function g(){return c()}},2021:(e,t,r)=>{r.d(t,{u:()=>a});var n=r(1185),o=r.n(n);let i=!1;async function a(){if(!i)try{await o().connect(process.env.MONGODB_URI||"mongodb://localhost:27017/tv_timer_prod"),i=!0,console.log("MongoDB connected")}catch(e){throw console.error("MongoDB connection error:",e),e}}},5310:(e,t,r)=>{r.d(t,{z:()=>a});var n=r(1185),o=r.n(n);let i=new(o()).Schema({tv:{type:o().Schema.Types.ObjectId,ref:"TV",required:!0},tvName:{type:String,required:!0},tvIpAddress:{type:String,required:!0},psType:{type:String,required:!0},startTime:{type:Date,required:!0},duration:{type:Number,required:!0},status:{type:String,enum:["Active","Ended"],default:"Active"},fee:{type:Number,required:!0}},{timestamps:!0}),a=o().models.Session||o().model("Session",i)},2880:(e,t,r)=>{r.d(t,{TV:()=>a});var n=r(1185),o=r.n(n);let i=new n.Schema({name:{type:String,required:!0},ipAddress:{type:String,required:!0},offlineCount:{type:Number,default:0},status:{type:String,enum:["Idle","Active","Offline","Ended"],default:"Idle"},currentSessionId:{type:o().Schema.Types.ObjectId,ref:"Session"},psType:{type:String,required:!0}},{timestamps:!0}),a=o().models.TV||o().model("TV",i)},9303:(e,t,r)=>{e.exports=r(517)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948],()=>r(4956));module.exports=n})();